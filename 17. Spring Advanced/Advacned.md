# Advanced



### Exception

JPA 표준 예외들은 `javax.persistence.PersistenceException` 의 자식클래스이며, 이 예외 클래스는 `RuntimeException`의 자식이다. 따라서 JPA 예외는 모두 언체크 예외다. 그리고 JPA 표준 예외는 2가지가 있다.

- 트랜잭션 롤백을 표시하는 예외
- 트랜잭션 롤백을 표시하지 않는 예외

롤백을 표시하는 예외는 심각한 예외이므로 복구해선 안된다. 이 예외가 발생하면 트랜잭션을 강제로 커밋해도 트랜잭션이 커밋되지 않고 대신에 `RollbackException` 예외가 발생한다. 반면 롤백을 표시하지 않는 예외는 심각한 예외가 아니며, 개발자가 커밋할지 롤백할지 판단할 수 있다.

다만 조심할 점으로 롤백하는 것은 데이터베이스의 반영사항만 롤백하는 것이지 수정한 자바 객체까지 원상태로 복구해주지는 않는다. 따라서 트랜잭션을 롤백하면 데이터베이스의 데이터는 원래대로 복구되지만 객체는 수정된 상태로 영속성 컨텍스트에 남아 있다. 그래서 그대로 사용하는 것은 위험하다. (제때 `clear` 를 해주는 방법으로 문제를 예방시킬 수 있다.) 기본 전략인 트랜잭션당 영속성 컨텍스트 전략은 문제가 발생해도 트랜잭션 AOP 종료 시점에 트랜잭션을 롤백하면서 영속성 컨텍스트도 함께 종료하므로 문제가 발생하지 않는다. OSIV처럼 범위를 넓게 사용하는 경우 문제가 생길 수 있으니 주의하자.



### Entity Comparison

영속성 컨텍스트 내부엔 1차 캐시가 있다. 그리고 1차 캐시는 영속성 컨텍스트와 생명주기가 같다. 그리고 이 1차 캐시 덕분에 약간의 성능이점과 **애플리케이션 수준의 반복 가능한 읽기를 제공**한다. 단순히 동등성 비교수준이 아니라 주소값이 같은 인스턴스를 반환한다. 만약 **영속성 컨텍스트가 같다면** 엔티티를 비교할 때 다음 3개가 모두 같다.

- 동일성: `==` 를 만족한다.
- 동등성: `equals()`를 만족한다.
- 데이터베이스 동등성: `@Id` 인 데이터베이스 식별자가 같다.

다만 영속성 컨텍스트가 다르면 `==` 비교를 실패하고, `equals()`를 만족시킬 수 있다. 데이터베이스 동등성은 엔티티를 영속화해야 식별자값이 존재하므로 이게 비교가능하다고 보장하기가 힘들다. 따라서 동등성 비교를 위해 `equals()`를 오버라이딩 해야하며, 중복되지 않고 거의 변하지 않는 비즈니스 키로 비교하면 된다. 회원의 연락처, 아이디 같은 정보들을 말한다.



### Proxy

