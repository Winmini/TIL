# Replication 



복제는 고가용성 환경을 위해 필요한 기술이다. 복제를 이용하면 물리적으로 데이터베이스가 망가지거나, 연결이 끊어지는 극단적인 상황에서도 빠른 복구를 보장할 수 있다.



데이터베이스에서 복제는 여러 서버가 서로의 역할을 나누어 정보를 동기화하는 것을 의미한다. 대부분의 DBMS는 복제를 구성하려면 외부의 툴을 배워서 적용해야 하지만 MongoDB는 이런 복제의 기능을 DBMS 내부적으로 지원한다.

복제의 가장 큰 목적은 MongoDB 인스턴스에 문제가 생겼을 때 정보가 복제된 다른 인스턴스를 이용해서 문제가 생긴 인스턴스를 대체하는 것이다. 복제는 어떤 상황에서도 데이터베이스가 클라이언트와 지속해서 정상작동할 수 있도록 돕는다. 이런 환경을 '고 가용성 환경'이라고 한다.

이런 고 가용성 환경 외에도 다른 목적을 이루는데 사용할 수 있다. 복제를 하고 난 후 복제된 인스턴스들을 이용해서 읽기 작업의 부하를 분산시킬 수 있다. 하지만 복제된 인스턴스는 변경된 정보를 동기화하는데 시간이 걸린다. 이 때문에 읽기 작업을 분산시키면 변경된 사항이 즉시 반영되지 않는 부작용이 있기도 하다.

카카오톡 프로필 사진 같은 것은 변경했을 때 일정 시간이 지나야 변경된 것을 볼 수 있는데, 이런 경우 복제를 이용해서 읽기 작업을 수행하고 있다고 의심할만 하다.



MongoDB에서 복제를 수행하기 위해서는 여러 mongod 인스턴스가 모인 "묶음"이 필요하다. 이 묶음에 속하게 되면 서로의 정보를 동기화한다. 이 처럼 복제를 수행하기 위한 인스턴스의 묶음을 '복제 세트'라고 부른다. 복제 세트에는 다양한 종류의 구성원이 존재한다. 클라이언트와 읽기 및 쓰기 작업을 하는 '프라이머리(Primary) 구성원', 프라이머리 구성원의 정보를 동기화하는 '세컨더리(Secondary) 구성원', 정보를 저장하지는 않고 복제 세트의 복구를 돕는 '아미터(Arbiter) 구성원' 이렇게 세 가지 종류의 구성원이 복제 세트를 구성한다.



### 복제 세트의 구성원

**구성원의 공통 기능**

기본적으로 복제 세트의 구성원은 돌발 상황에 대비하기 위한 기능을 가지고 있다. 복제 세트에 문제가 발생했는지 파악하기 위해 구성원이 서로 살아있는지 10초마다 '핑'을 보내 확인하는 작업을 수행한다. 이러한 작업을 '하트비트(heartbeat)'라고 한다. 이 기능으로 문제를 발견하고 나서는 문제 상황을 해결하기 위해 프라이머리 구성원을 선출하는 '선거'를 진행한다. 각각의 구성원은 대부분 투표를 할 수 있다.



**프라이머리 구성원의 기능**

프라이머리 구성원은 클라이언트와 소통하면서 직접적으로 정보를 읽거나 쓰는 작업을 수행한다. 또한 프라이머리 구성원은 각각의 복제 세트에서 오직 하나만 존재할 수 있다. 아무래도 클라이언트와 직접적으로 소통하는 부분이라, 프라이머리 서버가 작동을 멈추거나 네트워크상 연결이 끊어지면 다른 복제 세트 구성원이 있더라도 클라이언트가 일시적으로 정보를 읽고 쓰지 못하게 된다.



**세컨더리 구성원의 기능**

프라이머리에 연결되어 정보를 복제하는 인스턴스를 '세컨더리 구성원'이라고 한다. 복제 세트에서는 프라이머리 서버의 변경된 정보를 세컨더리 서버가 지속적으로 동기화하면서 만약 프라이머리가 문제가 발생하면 세컨더리 구성원 중 하나가 프라이머리 구성원이 된다. 일종의 예비 프라이머리 구성원이라고 생각하면 이해가 쉽다. 그리고 나중에 선거가 열릴 때 후보가 되는데, 우선순위가 높은 구성원이 프라이머리가 된다. 우선순위의 값을 0으로 설정할 수도 있는데 이런 구성원은 선거때 후보가 되지 못한다.

'읽기 요청 분담'하기도 한다. 다만 정보 반영이 바로 되어야 하는 서비스에는 안쓰는 것이 좋다. 약간 뒤늦게 업데이트 될 수 있기 때문이다.

프라이머리의 정보를 일정 시간 늦게 반영하는 기능이 있다. 이런 구성원을 '지연된 복제 구성원'이라고 부른다. 이 구성원은 선거의 후보로 나서지 않고, 투표권도 가지고 있지 않다. 이 구성원은 사람의 실수를 예방하도록 도와준다. 게임 서비스의 대규모 업데이트 후, 문제가 발생하면 이를 통해 롤백할 수 있다. 그 경우 이 구성원을 프라이머리로 교체하면 된다.



**아비터 구성원의 기능**

