# OSI - Layer 4

전송 계층의 역할에 대해 알아보자.



#### 전송 계층의 두 가지 역할

네트워크 계층에서 다른 네트워크로 데이터를 전송하기 위해서는 라우터가 필요하고, 라우터의 라우팅 기능을 사용하여 전송할 수 있다고 했다. 하지만 라우팅 기능을 이용하더라도 데이터가 목적지에 도착하지 못할 수 있다. 1, 2, 3계층이 있으면 목적지에 데이터를 보낼 수는 있지만, 중간에 데이터가 손상되거나 유실되어도 이 계층들이 아무것도 해주지 않는다.

그래서 전송 계층에서는 **오류를 점검하는 기**능이 있다. 오류가 발생하면 데이터를 재전송하도록 요청한다. 또 하나는 컴퓨터가 데이터를 받아도 어떤 애플리케이션에 전달해야 하는지 모르면 곤란하다. 그래서 해당 데이터가 **어떤 애플리케이션에서 사용하는 데이터인지 판단**해야 한다.



#### 연결형 통신과 비 연결형 통신

전송 계층의 특징을 간단히 설명하면 **신뢰성(정확성)**과 **효율성**으로 구분할 수 있다. 데이터를 목적지에 문제없이 전달하는 것과, 빠르고 효율적으로 전달하는 것이다. 신뢰가 가능하며 정확한 데이터를 전달하는 통신을 연결형 통신이라고  하고, 효율적으로 데이터를 전달하는 통신을 비연결형 통신이라고 한다.

**연결형 통신이 TCP이고, 비연결형이 UDP**이다. 동영상을 전달하는 경우 비연결형 통신을 사용한다. 신뢰, 정확한 데이터 보다 빠른 전송이 더 필요하기 때문이다.



### TCP

연결형 통신인 TCP로 전송할 때 붙이는 헤더를 TCP 헤더라고 한다. 그리고 이 TCP 헤더가 붙은 데이터를 **세그먼트**라고 한다. 여기에는 출발지 포트 번호, 목적지 포트 번호, 확인 응답 번호 등, 목적지까지 데이터를 제대로 전송하기 위해 필요한 정보를 가지고 있다. 그리고 그 코드 비트부분이 있다.

**코드 비트**

데이터를 전송하려면 먼저 **연결**이라는 가상의 독점 통신로를 확보해야 한다. 이 연결을 확립한 후에야 데이터를 전송할 수 있다. 이 코드 비트는 6 비트로 이뤄져 있는데, 여기에 연결의 제어 정보가 기록되어 있다. 그 중 **SYN**(연결 요청), **ACK**(확인 응답)으로 연결을 확립할 수 있다. 신뢰할 수 있는 연결을 하려면 데이터를 전송해야 하는데 하기 전에 패킷을 교환한다. 3번 교환하는데, SYN, SYN + ACK, ACK을 교환하여 연결이 확립된다. 연결이 확립되면 1로 활성화 된다. 그리고 이 과정을 **3-way 핸드셰이크**라고 한다.

연결을 종료할 때에는 **FIN**과 **ACK**를 사용한다. 이 과정에서는 FIN, ACK, FIN, ACK로 4번에 걸쳐서 종료된다.



#### 일련번호와 확인 응답 번호

3-way 핸드셰이크가 끝나고 실제 데이터를 보내거나 상대방이 받을 때는 TCP 헤더의 일련번호와 확인 응답 번호를 사용한다. 일련번호는 송신 측에서 수신측에 '**이 데이터가 몇 번째 데이터인가**' 알려 주는 역할을 한다.

확인 응답 번호는 수신 측이 **몇 번째 데이터를 수신했는지** 송신측에 알려주는 역할을 한다. 그래서 다음 번호의 데이터를 요청하는 데도 사용된다.

이 두 번호를 통해서 데이터가 손상되거나 유실된 경우 재전송하게 되어 있다. 이것을 **재전송 제어**라고 한다.



#### 윈도우 크기

위와 같이 세그먼트 하나 보낼 때마다 확인 응답을 한 번 반환하는 통신도 있지만, 이런 통신은 효율이 높지 않다. 그래서 매번 확인 응답을 기다리는 대신 세그먼트를 연속해서 보내고 난 다음에 확인 응답을 반환하면 효율이 높아진다. 이 **세그먼트는 일시적으로 버퍼에 보관**한다. 이 버퍼로 세그먼트를 연속해서 보내도 수신칙은 대응하기도 좋고 확인 응답의 효율도 좋아진다. 다만 세그먼트를 대량으로 받아서 처리하지 못하면 문제가 생긴다. 보관하지 못하고 넘치면 **오버플로**가 발생한다. 그래서 이 버퍼의 한계 크기를 알고 있어야 하므로, 이것이 TCP 헤더의 윈도우 크기에 해당한다. 이 크기는 확인 응답을 일일이 하지 않고 연속해서 얼마나 송수신 할 수 있는지도 파악할 수 있다.



#### 포트 번호

한 서버 내에도 다양한 애플리케이션이 있을 수 있다. 이를 구분하기 위해 포트번호를 사용하며, 그래야 처리하는 쪽도 보내는 쪽도 혼선이 없다. 이를 위해 TCP 헤더에는 **출발지 포트 번호**와 **목적지 포트 번호**가 필요하다.



### UDP

UDP는 효율이 중요해서 확인 작업을 별도로 하지 않는다. 그래서 스트리밍 방식으로 전송하는 동영상 서비스 같은 방법에 주로 사용된다. UDP 헤더에는 출발지 포트 번호, 목적지 포트 번호, 길이, 체크섬 이렇게 담겨져 있다. 그리고 확인같은 것이 필요 없이 그냥 계속 보내버린다. 특정 컴퓨터나 네트워크 장비가 누군지 구분을 하지 않아도 되기 때문에 **브로드캐스트**에도 적합하다.



**참고**

- TCP 헤더가 있는 데이터: 세그먼트
- UDP 헤더가 있는 데이터: UDP 데이터그램