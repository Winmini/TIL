# OSIV



- Open Session In View: 하이버네이트
- Open EntityManager In View: JPA

원래 하이버네이트에서 Open Session In View의 약자로 OISV이라는 것이 있다. JPA에서 엔티티 매니저가 하이버네이트에서는 세션이였는데, 관례상 OSIV이라고 부르고 있다.



OSIV이 과연뭘까?

스프링에서는 이 OSIV을 true로 켜놓는 것이 기본 값이다. 설정에 보면 `spring.jpa.open-in-view`

가 true로 설정되어 있다. 그래서 보통은 신경쓰지 않았겠지만, 스프링서버를 키고 중간에 보면 WARN이라고 경고가 하나 섞여 있음을 볼 수 있다.

```java
WARN 7016 --- [  restartedMain] JpaBaseConfiguration$JpaWebConfiguration : spring.jpa.open-in-view is enabled by default. Therefore, database queries may be performed during view rendering. Explicitly configure spring.jpa.open-in-view to disable this warning
```

먼저 이 위험성에 대해 얘기하기 전에 트랜잭션에 부터 생각해보자. 스프링에서 DB와 커넥션을 언제 가져와서 언제 끊어야 할까? 디비마다 시작점은 조금씩 다르겠지만 대체로 `Service` 객체에서 `@Transactional` 애너테이션이 있는데, 이 트랙잭션이 시작할 때 커넥션을 가져올 것이다. 근데 이 애너테이션을 달고 있는 메서드값이 리턴되어도 커넥션이 끊기지 않는다. 왜냐하면 우리가 그 값을 이용하더라도 LAZY로 지연로딩이 되어 있거나, 우리가 가져온 객체의 attribute를 proxy객체로 채워놓고 필요한 시점에 다시 쿼리를 날려서 가져와야 한다. 이러려면 영속성 컨텍스트는 기본적으로 DB와 커넥션을 유지하고 있다. 커넥션이 끊겨 있으면 다시 연결해야 하므로 불편할 것이고, 연결되어 있는 것이 낫다.

그래서 REST API (혹은 HTTP API) 일 경우 값을 돌려주는 시점, JSP나 HTML을 렌더링하는 경우 뷰로 값을 보내주는 시점 쯤에 DB 커넥션을 끊는다. 큰 장점이라고 할 수 있다.



근데 이 전략의 치명적인 단점이 있다. 이 전략이 생각보다 너무 오랜시간동안 데이터베이스 커넥션 리소스를 사용한다. 그래서 실시간 트래픽이 중요한 애플리케이션은 커넥션이 모자랄 수 있고, 이는 결국 장애로 이어진다. 예를 들어 컨트롤러에서 혹시라도 외부 API를 호출했는데 외부 API가 3초가 걸린다면  혹은 어떤 오류로 인해 계속 값을 얻어내지 못하고 있다면 아직 값을 반환하지 못했기 때문에 커넥션이 계속 유지되어 결국 DB 커넥션이 말라버린다.



OSIV를 OFF할 수 있다. 만약 OFF시키면 영속성 컨텍스트의 생존주기는 트랜잭션의 범위 안에서만 살아있게 된다. 트랜잭션을 종료하는 순간 영속성 컨텍스트를 닫고, 데이터베이스 커넥션도 반환한다. 그래서 커넥션 리소스를 낭비하지 않는다. 당연히 OSIV를 끄면 트랜잭션 안에서 모든 지연로딩을 처리해야 한다. 따라서 지금까지 작성된 많은 지연 로딩 코드는 트랜잭션 안으로 밀어 넣어야 한다.



**끄고 연습해보자**



### 커멘드와 커리 분리

실무에서 OSIV를 끈 상태로 복잡성을 관리하는 좋은 방법이 있다. Command와 Query를 분리하는 것이다. service패키지 말고 query패키지를 새로 생성하여 분류해서 작업하는 것이다.

보통 비즈니스 로직은 특정 엔티티 몇개를 등록하거나 수정하는 것이므로 성능이 크게 문제가 되지 않는다. 근데 복잡한 화면을 출력하기 위한 쿼리는 화면에 맞추어 성능을 최적화 하는 것이 중요하다. 하지만 그 복잡성에 비해 핵심 비즈니스에 큰 영향을 주지는 않는다.

그래서 크고 복잡한 애플리케이션을 개발하면, 이 둘의 관심사를 명확하게 분리하는 것이 좋을 수 있다.

- OrderService
  - OrderService: 핵심 비즈니스 로직
  - OrderQueryService: 화면이나 API에 맞춘 서비스 (주로 읽기 전용 트랜잭션을 사용)

더 깊이 알기 위해 JPA 프로그래밍 김영한 저 13장을 읽어보자.